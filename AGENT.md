# 开发指南

## 沟通要求
- 用简洁易懂的中文沟通
- 默认 Go 语言开发

## 权限管理
**自动执行**：文件读写修改、运行测试/构建/格式化/检查、安装依赖、git 查看和分支操作

**需要我确认**：文件删除、数据库操作、发布/部署

**仅在我主动要求时执行**：git add、git commit、git push、强制操作（force push, reset --hard 等）。代码准备好后告诉我已完成，由我决定如何处理 git 操作。

## 开发流程

### 规划
- 复杂任务（>3个文件、需要架构决策、多种实现方式）, 创建 `IMPLEMENTATION_PLAN.md`，拆分为3-5个阶段
- 每阶段包含：目标、验收标准、测试用例、状态（未开始|进行中|已完成）
- 全部完成后删除该文件

### 实施
1. **理解需求** - 研究代码库中的现有设计模式，找3个类似实现参考
2. **开发实现** - 编写最精简的代码使测试通过
3. **重构优化** - 保持测试通过的前提下清理代码

### 遇到阻塞时（3次尝试后停止）
1. 记录失败情况（已尝试方案、错误信息、原因分析）
2. 研究2-3个替代方案并评估优劣
3. 向我汇报：总结失败原因 + 替代方案 + 推荐方案，等待我的决策

## Go 技术标准

### 核心原则
- 组合优于继承，接口优于单例，显式优于隐式
- 接口定义在使用方
- 标准库优先，引入第三方库前评估必要性
- 使用 `gofmt`/`goimports` 格式化，`golangci-lint` 检查

### 编码规范
- 函数单一职责，保持小而专注
- 避免过早抽象，拒绝炫技
- 保持现有行为和配置，不随意改变已有功能
- 不重构架构级代码，除非明确需要

### 错误处理
- 返回 error 而非 panic（panic 仅用于不可恢复错误）
- 每个 error 必须检查，尽早返回，避免深层嵌套
- `fmt.Errorf("context: %w", err)` 包装错误，添加上下文
- `errors.Is()`/`errors.As()` 检查特定错误类型
- context.Context 作为第一个参数，长时间操作必须支持取消

### 并发处理
- goroutine 必须有退出机制，用 context 控制生命周期
- channel 遵循"发送方关闭"原则
- 共享数据优先用 channel，必要时用 sync.Mutex

### 测试策略
**必须运行完整测试**：准备提交前、完成功能模块后、修复 bug 后、重构后

**可选运行部分测试**：开发过程中只测相关模块（`go test ./pkg/xxx`）

**不需要测试**：改注释/文档、调格式、探索试错阶段

### 提交前检查
编译通过 → 全部测试通过 → `gofmt` 无警告 → `golangci-lint` 无警告 → `go mod tidy` → 自我审查 → 告诉我已完成

## 决策优先级
可测试性 > 可读性 > 一致性 > 简洁性 > 可逆转性

## 重要提醒
**严禁**：`--no-verify` 绕过钩子、禁用测试、提交无法编译的代码、凭假设开发、主动执行 git add/commit/push

**必须**：先研究现有代码再动手、3次失败后停止汇报、遇到不确定时主动询问